## HTML 网页和结构
### 网页结构

HTML 网页是利用 HTML 语言编写的文档，是一种半结构化的数据表现方式。它的结构特征包括：

- 树状结构：略。
- 层次结构：z 轴上的层次。
- 框结构：frame、iframe、frameset。

知晓这些是分析 WebKit 网页渲染过程的基础。 

### WebKit 渲染过程

三个阶段：

1. 从网页 URL 到构建完 DOM 树。
2. 从 DOM 树到构建完 WebKit 绘图上下文。
3. 从绘图上下文到生成最终图像。

#### 第一阶段

1. 输入 URL，WebKit 调用资源加载器加载对应网页。
2. 加载器依赖网络模块建立连接，发送请求并接受响应结果。
3. WebKit 接收到各种网页或资源的数据。
4. 网页被交给 HTML 解释器转变成一系列 Token。
5. 解释器根据 Token 构建节点，形成 DOM 树。
6. 如果节点是 JavaScript，则 解释执行（阻塞），可能会修改页面结构。
7. 如果节点依赖其他资源（Css 和图片等），资源加载器异步加载，如果是 JavaScript 资源（没有标记异步的情况下），阻塞 DOM 创建，加载并执行，完成后才继续 DOM 树创建。

> 在上述过程中还有两个重要的全局的事件：`DOMContentLoaded` 和 `onload`。分别在 DOM 树创建完成以及所有资源加载完成时触发。

#### 第二阶段

1. Css 文件被 Css 解释器解释成内部表示结构。
2. 在 DOM 树上附加样式信息，形成 `RenderObject` 树。
3. `RenderObject` 节点在创建的同时，WebKit 会根据网页的层次结构创建 `RenderLayer` 树，同时构建一个虚拟的绘图上下文。

#### 第三阶段

1. 绘图上下文是一个平台无关的抽象类，它将每个绘图操作桥接到不同的具体实现类，也就是绘图具体实现类。
2. 绘图实现类有简单和复杂的实现，在 Chromium 中，实现相当复杂，需要 Chromium 合成器来完成复杂的多进程和 GPU 加速机制。
3. 绘图实现类将 2D 图形库或 3D 图形库绘制的结果保存下来，交给浏览器来同浏览器界面一起显示。

> 实际的渲染过程会复杂很多，但是整体的流程和上面讲的大体一致。